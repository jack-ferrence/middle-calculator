<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Will’s Middling & Hedge Calculator</title>
  <style>
    :root{
      --bg:#0b0e16;
      --panel:#121827;
      --panel2:#0f1422;
      --line:#253052;
      --muted:#a8b0c4;
      --text:#e9ecf5;
      --accent:#7aa2ff;
      --accent2:#31d0aa;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --good:#44d18d;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% 10%, rgba(122,162,255,.25), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(49,208,170,.20), transparent 55%),
                  radial-gradient(900px 600px at 50% 110%, rgba(255,204,102,.15), transparent 60%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px 56px}
    header{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin:0;color:var(--muted);font-size:13px}
    .badge{
      border:1px solid var(--line);
      padding:10px 12px;border-radius:999px;
      background:rgba(18,24,39,.55);
      box-shadow: var(--shadow);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .badge b{color:var(--text)}
    .stepper{
      display:flex;gap:10px;align-items:center;
      margin:16px 0 12px;
      user-select:none;
    }
    .step{
      flex:1;
      border:1px solid rgba(37,48,82,.8);
      background: rgba(18,24,39,.45);
      border-radius: 14px;
      padding:10px 10px;
      display:flex;gap:10px;align-items:center;
      cursor:pointer;
      transition:.15s transform ease, .15s border-color ease, .15s background ease;
    }
    .step:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.55)}
    .step.active{
      background: linear-gradient(180deg, rgba(122,162,255,.20), rgba(18,24,39,.55));
      border-color: rgba(122,162,255,.7);
    }
    .step .n{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(15,20,34,.9);
      border:1px solid rgba(37,48,82,.9);
      font-weight:800;
      color: var(--muted);
    }
    .step.active .n{color: var(--text); border-color: rgba(122,162,255,.7)}
    .step .t{line-height:1.05}
    .step .t b{display:block;font-size:12px}
    .step .t span{display:block;font-size:11px;color:var(--muted);margin-top:3px}
    .panel{
      border:1px solid rgba(37,48,82,.75);
      background: rgba(18,24,39,.45);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      margin-top: 10px;
    }
    .panelTitle{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px
    }
    .panelTitle h2{
      font-size:14px;margin:0;letter-spacing:.2px
    }
    .panelTitle .hint{font-size:12px;color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column;align-items:flex-start}
      .badge{align-self:flex-start}
      .stepper{flex-direction:column}
      .step{width:100%}
    }
    .row{display:flex;gap:10px;align-items:center}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(37,48,82,.9);
      background: rgba(15,19,32,.8);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.0);
    }
    input:focus, select:focus{
      border-color: rgba(122,162,255,.8);
      box-shadow: 0 0 0 3px rgba(122,162,255,.15);
    }
    .pillRow{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(37,48,82,.9);
      background: rgba(15,19,32,.75);
      font-size:12px;color:var(--muted);
      cursor:pointer;
      transition:.15s border-color ease, .15s background ease, .15s transform ease;
    }
    .pill:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.55)}
    .pill.active{
      color: var(--text);
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.75);
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{
      border:1px solid rgba(37,48,82,.9);
      background: rgba(15,19,32,.8);
      color: var(--text);
      padding:10px 12px;border-radius: 12px;
      cursor:pointer;
      transition:.15s transform ease, .15s border-color ease, .15s background ease;
      font-weight:700;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.55)}
    button.primary{
      background: linear-gradient(180deg, rgba(122,162,255,.28), rgba(15,19,32,.75));
      border-color: rgba(122,162,255,.75);
    }
    button.good{
      background: linear-gradient(180deg, rgba(68,209,141,.20), rgba(15,19,32,.78));
      border-color: rgba(68,209,141,.65);
    }
    .small{font-size:12px;color:var(--muted)}
    .sep{height:1px;background: rgba(37,48,82,.6);margin:12px 0}
    .kpiGrid{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px;margin-top:12px}
    @media (max-width: 820px){.kpiGrid{grid-template-columns:1fr}}
    .kpi{
      border:1px solid rgba(37,48,82,.75);
      background: rgba(15,19,32,.55);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .kpi h3{margin:0 0 6px;font-size:12px;color:var(--muted);font-weight:600}
    .kpi .v{font-size:20px;font-weight:800;letter-spacing:.2px}
    .kpi .subv{font-size:12px;color:var(--muted);margin-top:2px}
    .big{
      font-size:32px;font-weight:900;letter-spacing:.3px;margin:0
    }
    .bigSub{margin:0;color:var(--muted);font-size:12px}
    .goodTxt{color:var(--good)}
    .badTxt{color:var(--bad)}
    .warnTxt{color:var(--warn)}
    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(37,48,82,.75);
      margin-top:10px;
      background: rgba(15,19,32,.45);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(37,48,82,.55);
      font-size:12px;
      vertical-align:top;
    }
    .table th{
      text-align:left;
      color: var(--muted);
      font-weight:700;
      background: rgba(18,24,39,.55);
    }
    .table tr:last-child td{border-bottom:none}
    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .range{
      font-size:12px;color:var(--muted);margin-top:3px
    }
    .sliderWrap{
      border:1px solid rgba(37,48,82,.75);
      background: rgba(15,19,32,.45);
      border-radius: 14px;
      padding: 12px 12px;
      margin-top:10px;
    }
    .sliderHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .sliderHeader b{font-size:12px}
    input[type="range"]{padding:0; border:none; background:transparent}
    .note{
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(37,48,82,.85);
      background: rgba(15,19,32,.55);
      font-size:12px;color:var(--muted);
    }
    .chip b{color:var(--text)}
    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .mini{
      border:1px solid rgba(37,48,82,.75);
      background: rgba(15,19,32,.55);
      border-radius:14px;
      padding:10px 12px;
    }
    .mini h4{margin:0 0 6px;font-size:12px;color:var(--muted);font-weight:600}
    .mini .v{font-size:18px;font-weight:800}
    .footerNote{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.35}
    .hidden{display:none}

    /* --- Gift photo decorations (non-destructive) --- */
    .giftTop, .giftBottom{
      width: min(1100px, 100%);
      margin: 18px auto;
      padding: 0 16px;
      box-sizing: border-box;
    }
    .giftTop img, .giftBottom img{
      display:block;
      width:100%;
      height:auto;
      object-fit:contain;
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
    }

    /* Side "popup ad" style, but never crop the image */
    .sideAd{
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      z-index: 999;
      width: 220px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(10,12,22,.72);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .sideAd.left{ left: 10px; }
    .sideAd.right{ right: 10px; }
    .sideAd img{
      display:block;
      width:100%;
      height:auto;
      max-height: 82vh;
      object-fit: contain;
      border-radius: 12px;
    }
    @media (max-width: 1200px){
      .sideAd{ display:none; }
    }
    @media (min-width: 1201px){
      body{ padding-left: 250px; padding-right: 250px; }
      .wrap{ margin: 28px auto; }
    }

  </style>
</head>
<body>
  <!-- Gift photo decorations -->
  <div class="giftTop">
    <img src="top%20photo.png" alt="Will’s Middling & Hedging Calculator - Top Banner" loading="eager" decoding="async"/>
  </div>

  <div class="sideAd left" aria-hidden="true">
    <img src="photo%201.png" alt="Gift photo left" loading="lazy" decoding="async"/>
  </div>
  <div class="sideAd right" aria-hidden="true">
    <img src="photo%202.png" alt="Gift photo right" loading="lazy" decoding="async"/>
  </div>

  <div class="wrap">
    <header>
      <div>
        <h1>Will’s Middling & Hedge Calculator</h1>
        <p class="sub">Fast payout math for live middles and hedges (neutral calculator).</p>
      </div>
      <div class="badge">
        Default unit: <b>$20</b><br/>
        Live odds drift: <b>±15</b>
      </div>
    </header>

    <div class="stepper" id="stepper">
      <div class="step active" data-step="1">
        <div class="n">1</div>
        <div class="t"><b>Setup</b><span>League + teams</span></div>
      </div>
      <div class="step" data-step="2">
        <div class="n">2</div>
        <div class="t"><b>Pregame</b><span>Original bet</span></div>
      </div>
      <div class="step" data-step="3">
        <div class="n">3</div>
        <div class="t"><b>Live</b><span>Hedge/middle bet</span></div>
      </div>
      <div class="step" data-step="4">
        <div class="n">4</div>
        <div class="t"><b>Results</b><span>Payouts + ranges</span></div>
      </div>
    </div>

    <!-- PANEL 1 -->
    <section class="panel" id="panel1">
      <div class="panelTitle">
        <h2>1) Setup</h2>
        <div class="hint">Pick league, teams, and bet type.</div>
      </div>

      <div class="grid">
        <div>
          <label>League</label>
          <select id="league">
            <option value="NFL">NFL (football)</option>
            <option value="NBA">NBA (basketball)</option>
          </select>
          <div class="note">Team dropdowns include every team in the selected league. Defaults are Team A / Team B.</div>
        </div>

        <div>
          <label>Bet type</label>
          <div class="pillRow" id="betTypeRow">
            <div class="pill active" data-type="spread">Spread</div>
            <div class="pill" data-type="total">Total (O/U)</div>
            <div class="pill" data-type="ml">Moneyline</div>
            <div class="pill" data-type="prop">Prop (O/U)</div>
          </div>
          <div class="note">Neutral calculator. Uses American odds and standard payout math.</div>
        </div>

        <div>
          <label>Team A</label>
          <select id="teamA"></select>
        </div>

        <div>
          <label>Team B</label>
          <select id="teamB"></select>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="to2">Next → Panel 2</button>
        <span class="small">Move left-to-right: 1 → 2 → 3 → 4</span>
      </div>
    </section>

    <!-- PANEL 2 -->
    <section class="panel hidden" id="panel2">
      <div class="panelTitle">
        <h2>2) Pregame bet (original)</h2>
        <div class="hint">Enter the bet you already have.</div>
      </div>

      <div class="grid">
        <div>
          <label>Side (what you bet)</label>
          <select id="preSide">
            <option value="A">Team A</option>
            <option value="B">Team B</option>
            <option value="over">Over</option>
            <option value="under">Under</option>
          </select>
        </div>

        <div>
          <label>Line / number</label>
          <input id="preLine" type="number" step="0.5" value="-3.5"/>
          <div class="note" id="preLineHint">Examples: -3.5 (spread) • 45.5 (total) • 1.5 (prop) • leave blank for ML</div>
        </div>

        <div>
          <label>Stake ($)</label>
          <input id="preStake" type="number" step="1" value="20"/>
        </div>

        <div>
          <label>Odds (American)</label>
          <input id="preOdds" type="number" step="1" value="-110"/>
          <div class="note">Examples: -110, +120, -135</div>
        </div>
      </div>

      <div class="btnRow">
        <button id="back1">← Back to Panel 1</button>
        <button class="primary" id="to3">Next → Panel 3</button>
      </div>
    </section>

    <!-- PANEL 3 -->
    <section class="panel hidden" id="panel3">
      <div class="panelTitle">
        <h2>3) Live hedge / middle bet</h2>
        <div class="hint">Enter the live bet opportunity.</div>
      </div>

      <div class="grid">
        <div>
          <label>Live side (what you’d bet now)</label>
          <select id="liveSide">
            <option value="B">Team B</option>
            <option value="A">Team A</option>
            <option value="over">Over</option>
            <option value="under">Under</option>
          </select>
        </div>

        <div>
          <label>Live line / number</label>
          <input id="liveLine" type="number" step="0.5" value="7.5"/>
          <div class="note" id="liveLineHint">Example: +7.5 (spread) • 52.5 (total) • 3.5 (prop) • leave blank for ML</div>
        </div>

        <div>
          <label>Live odds (American)</label>
          <input id="liveOdds" type="number" step="1" value="-110"/>
          <div class="note">We assume a ±15 drift range for live odds in the outputs.</div>
        </div>

        <div>
          <label>Max live stake slider ($)</label>
          <input id="liveStakeMax" type="number" step="1" value="200"/>
          <div class="note">Slider lets Will quickly see payout changes as stake changes.</div>
        </div>
      </div>

      <div class="sliderWrap">
        <div class="sliderHeader">
          <b>Live stake (use slider)</b>
          <span class="chip">Stake: <b class="mono" id="liveStakeLabel">$20</b></span>
        </div>
        <input id="liveStake" type="range" min="0" max="200" value="20" step="1"/>
        <div class="small">Tip: set max stake to the biggest hedge he’d actually consider.</div>
      </div>

      <div class="btnRow">
        <button id="back2">← Back to Panel 2</button>
        <button class="good" id="to4">Compute → Panel 4</button>
      </div>
    </section>

    <!-- PANEL 4 -->
    <section class="panel hidden" id="panel4">
      <div class="panelTitle">
        <h2>4) Results</h2>
        <div class="hint">Clear payouts for each outcome, with odds drift ranges.</div>
      </div>

      <div class="kpiGrid">
        <div class="kpi">
          <h3>If you do nothing (pregame bet only)</h3>
          <div class="v mono" id="kpiDoNothing">$0.00</div>
          <div class="subv" id="kpiDoNothingRange">(range: $0.00 to $0.00)</div>
        </div>
        <div class="kpi">
          <h3>Best-case (middle hits)</h3>
          <div class="v mono goodTxt" id="kpiBest">$0.00</div>
          <div class="subv" id="kpiBestRange">(range: $0.00 to $0.00)</div>
        </div>
        <div class="kpi">
          <h3>Worst-case (both lose possible)</h3>
          <div class="v mono badTxt" id="kpiWorst">$0.00</div>
          <div class="subv" id="kpiWorstRange">(range: $0.00 to $0.00)</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div>
          <p class="big mono" id="headline">$0.00</p>
          <p class="bigSub" id="headlineSub">(with odds drift range in parentheses)</p>

          <div class="miniGrid">
            <div class="mini">
              <h4>Pregame bet profit if it wins</h4>
              <div class="v mono" id="preWinProfit">$0.00</div>
            </div>
            <div class="mini">
              <h4>Live bet profit if it wins</h4>
              <div class="v mono" id="liveWinProfit">$0.00</div>
              <div class="range" id="liveWinProfitRange">(range: $0.00 to $0.00)</div>
            </div>
          </div>

          <div class="note" id="middleNote"></div>
        </div>

        <div>
          <table class="table" id="outTable">
            <thead>
              <tr>
                <th>Outcome bucket</th>
                <th>What happens</th>
                <th>P&L (exact)</th>
                <th>P&L range (±15 odds)</th>
              </tr>
            </thead>
            <tbody id="outBody"></tbody>
          </table>

          <div class="footerNote">
            Odds drift range: assumes live odds can move within ±15. Pregame odds are treated as locked.
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button id="back3">← Back to Panel 3</button>
        <button class="primary" id="copySummary">Copy summary</button>
        <span class="small" id="copyMsg"></span>
      </div>
    </section>

  </div>

  <script>
    // -------------------------
    // Data: Team lists
    // -------------------------
    const TEAMS = {
      NFL: [
        "Team A","Team B",
        "Arizona Cardinals","Atlanta Falcons","Baltimore Ravens","Buffalo Bills","Carolina Panthers","Chicago Bears",
        "Cincinnati Bengals","Cleveland Browns","Dallas Cowboys","Denver Broncos","Detroit Lions","Green Bay Packers",
        "Houston Texans","Indianapolis Colts","Jacksonville Jaguars","Kansas City Chiefs","Las Vegas Raiders",
        "Los Angeles Chargers","Los Angeles Rams","Miami Dolphins","Minnesota Vikings","New England Patriots",
        "New Orleans Saints","New York Giants","New York Jets","Philadelphia Eagles","Pittsburgh Steelers",
        "San Francisco 49ers","Seattle Seahawks","Tampa Bay Buccaneers","Tennessee Titans","Washington Commanders"
      ],
      NBA: [
        "Team A","Team B",
        "Atlanta Hawks","Boston Celtics","Brooklyn Nets","Charlotte Hornets","Chicago Bulls","Cleveland Cavaliers",
        "Dallas Mavericks","Denver Nuggets","Detroit Pistons","Golden State Warriors","Houston Rockets","Indiana Pacers",
        "LA Clippers","Los Angeles Lakers","Memphis Grizzlies","Miami Heat","Milwaukee Bucks","Minnesota Timberwolves",
        "New Orleans Pelicans","New York Knicks","Oklahoma City Thunder","Orlando Magic","Philadelphia 76ers",
        "Phoenix Suns","Portland Trail Blazers","Sacramento Kings","San Antonio Spurs","Toronto Raptors","Utah Jazz",
        "Washington Wizards"
      ]
    };

    // -------------------------
    // State
    // -------------------------
    let state = {
      betType: "spread",
      league: "NFL",
      teamA: "Team A",
      teamB: "Team B",
      pre: { side:"A", line:-3.5, stake:20, odds:-110 },
      live: { side:"B", line:7.5, odds:-110, stake:20, max:200 },
      drift: 15
    };

    const $ = (id) => document.getElementById(id);

    // -------------------------
    // Helpers: odds math
    // -------------------------
    function americanToDecimal(odds){
      const o = Number(odds);
      if(!isFinite(o) || o === 0) return 1;
      if(o > 0) return 1 + (o/100);
      return 1 + (100/Math.abs(o));
    }
    function profitForStake(stake, odds){
      const dec = americanToDecimal(odds);
      return stake * (dec - 1);
    }
    function fmtMoney(x){
      const n = Number(x);
      if(!isFinite(n)) return "$0.00";
      const sign = n < 0 ? "-" : "";
      const abs = Math.abs(n);
      return sign + "$" + abs.toFixed(2);
    }
    function clamp(n, a, b){ return Math.min(b, Math.max(a, n)); }

    // -------------------------
    // Buckets and evaluation
    // -------------------------
    function buildBuckets(){
      const bt = state.betType;

      if(bt === "ml"){
        // Only two outcomes: A wins or B wins
        return [
          { key:"A", label:"Team A wins",  test: (s)=> s === "A" },
          { key:"B", label:"Team B wins",  test: (s)=> s === "B" }
        ];
      }

      // spread / total / prop share a "score" style model:
      // We'll interpret "s" as final margin for spread, or final total for total/prop.
      // Buckets: pre wins only, live wins only, both win (middle), push zones, both lose (if possible)
      return [
        { key:"PRE", label:"Pregame wins (only)", kind:"pre_only" },
        { key:"LIVE", label:"Live wins (only)", kind:"live_only" },
        { key:"MIDDLE", label:"Middle (both win)", kind:"both_win" },
        { key:"PUSH_PRE", label:"Push pregame", kind:"push_pre" },
        { key:"PUSH_LIVE", label:"Push live", kind:"push_live" },
        { key:"BOTH_LOSE", label:"Both lose (if possible)", kind:"both_lose" },
      ];
    }

    function outcomeExplain(){
      const bt = state.betType;
      const preSide = state.pre.side;
      const liveSide = state.live.side;

      const A = state.teamA || "Team A";
      const B = state.teamB || "Team B";

      if(bt === "ml"){
        return {
          universe: "ML",
          describe: (bucketKey) => {
            if(bucketKey === "A") return `If ${A} wins`;
            return `If ${B} wins`;
          }
        };
      }

      const metric = (bt === "spread") ? "final margin (Team A score − Team B score)" :
                     "final total (points/units)";

      // Define win/push/loss tests for each bet, using a single metric value x.
      const preLine = Number(state.pre.line);
      const liveLine = Number(state.live.line);

      function betResult(side, line, x){
        // returns: "win" | "loss" | "push"
        if(bt === "spread"){
          // side is A or B; line is spread for that side
          // If bet on A with line -3.5, condition: margin + (-3.5) > 0
          // If bet on B with line +7.5, translate to margin for A; B +7.5 means (-margin) + 7.5 > 0 => margin < 7.5
          let expr;
          if(side === "A") expr = x + line;
          else expr = (-x) + line;
          if(Math.abs(expr) < 1e-9) return "push";
          return expr > 0 ? "win" : "loss";
        } else {
          // total/prop: side over/under; line is total threshold
          let expr;
          if(side === "over") expr = x - line;
          else expr = line - x;
          if(Math.abs(expr) < 1e-9) return "push";
          return expr > 0 ? "win" : "loss";
        }
      }

      return {
        universe: metric,
        describe: (bucketKey) => {
          if(bucketKey === "MIDDLE") return "Pregame wins and Live wins";
          if(bucketKey === "PRE") return "Pregame wins and Live loses";
          if(bucketKey === "LIVE") return "Live wins and Pregame loses";
          if(bucketKey === "PUSH_PRE") return "Pregame pushes (refund), Live resolves";
          if(bucketKey === "PUSH_LIVE") return "Live pushes (refund), Pregame resolves";
          if(bucketKey === "BOTH_LOSE") return "Both lose (rare but possible with some lines)";
          return "";
        },
        betResult
      };
    }

    // -------------------------
    // Compute payouts
    // -------------------------
    function compute(){
      const bt = state.betType;

      const preStake = Number(state.pre.stake) || 0;
      const preOdds = Number(state.pre.odds) || 0;
      const liveStake = Number(state.live.stake) || 0;
      const liveOdds = Number(state.live.odds) || 0;

      const liveOddsMin = liveOdds - state.drift;
      const liveOddsMax = liveOdds + state.drift;

      const preWinProfit = profitForStake(preStake, preOdds);
      const liveWinProfit = profitForStake(liveStake, liveOdds);
      const liveWinProfitMin = profitForStake(liveStake, liveOddsMin);
      const liveWinProfitMax = profitForStake(liveStake, liveOddsMax);

      const expl = outcomeExplain();

      // KPI: do nothing = either win profit or -stake depending on actual result; since unknown, show both scenarios as a range.
      // We'll present it as: "Win: +profit, Lose: -stake"
      const doNothingWin = preWinProfit;
      const doNothingLose = -preStake;

      $("kpiDoNothing").textContent = `${fmtMoney(doNothingWin)} / ${fmtMoney(doNothingLose)}`;
      $("kpiDoNothingRange").textContent = `(range: ${fmtMoney(doNothingWin)} to ${fmtMoney(doNothingLose)})`;

      // Build table
      const tbody = $("outBody");
      tbody.innerHTML = "";

      let best = -Infinity, bestMin=-Infinity, bestMax=-Infinity;
      let worst = Infinity, worstMin=Infinity, worstMax=Infinity;

      function addRow(bucket, happens, pnlExact, pnlMin, pnlMax){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${bucket}</b></td>
          <td>${happens}</td>
          <td class="mono ${pnlExact>=0?'goodTxt':'badTxt'}">${fmtMoney(pnlExact)}</td>
          <td class="mono">${fmtMoney(pnlMin)} to ${fmtMoney(pnlMax)}</td>
        `;
        tbody.appendChild(tr);
      }

      if(bt === "ml"){
        // Determine which team each bet is on: preSide is A/B, liveSide is A/B (we keep select values)
        const A = state.teamA || "Team A";
        const B = state.teamB || "Team B";

        // Outcome: A wins
        const preA = (state.pre.side === "A");
        const liveA = (state.live.side === "A");

        const pnlA_exact = (preA ? preWinProfit : -preStake) + (liveA ? liveWinProfit : -liveStake);
        const pnlA_min   = (preA ? preWinProfit : -preStake) + (liveA ? liveWinProfitMin : -liveStake);
        const pnlA_max   = (preA ? preWinProfit : -preStake) + (liveA ? liveWinProfitMax : -liveStake);

        // Outcome: B wins
        const preB = (state.pre.side === "B");
        const liveB = (state.live.side === "B");

        const pnlB_exact = (preB ? preWinProfit : -preStake) + (liveB ? liveWinProfit : -liveStake);
        const pnlB_min   = (preB ? preWinProfit : -preStake) + (liveB ? liveWinProfitMin : -liveStake);
        const pnlB_max   = (preB ? preWinProfit : -preStake) + (liveB ? liveWinProfitMax : -liveStake);

        addRow(`${A} wins`, `If ${A} wins`, pnlA_exact, pnlA_min, pnlA_max);
        addRow(`${B} wins`, `If ${B} wins`, pnlB_exact, pnlB_min, pnlB_max);

        // KPIs
        best = Math.max(pnlA_exact, pnlB_exact);
        worst = Math.min(pnlA_exact, pnlB_exact);
        bestMin = Math.max(pnlA_min, pnlB_min);
        bestMax = Math.max(pnlA_max, pnlB_max);
        worstMin = Math.min(pnlA_min, pnlB_min);
        worstMax = Math.min(pnlA_max, pnlB_max);

        $("kpiBest").textContent = fmtMoney(best);
        $("kpiBestRange").textContent = `(range: ${fmtMoney(bestMin)} to ${fmtMoney(bestMax)})`;
        $("kpiWorst").textContent = fmtMoney(worst);
        $("kpiWorstRange").textContent = `(range: ${fmtMoney(worstMin)} to ${fmtMoney(worstMax)})`;

        $("preWinProfit").textContent = fmtMoney(preWinProfit);
        $("liveWinProfit").textContent = fmtMoney(liveWinProfit);
        $("liveWinProfitRange").textContent = `(range: ${fmtMoney(liveWinProfitMin)} to ${fmtMoney(liveWinProfitMax)})`;

        $("headline").textContent = fmtMoney(best);
        $("headlineSub").textContent = `(live odds drift range: ${fmtMoney(bestMin)} to ${fmtMoney(bestMax)})`;

        $("middleNote").textContent = `ML: No “middle window” like spreads/totals. This is a hedge calculator for win/lose outcomes.`;
        return;
      }

      const preSide = state.pre.side;
      const liveSide = state.live.side;
      const preLine = Number(state.pre.line);
      const liveLine = Number(state.live.line);

      const btRes = expl.betResult;

      // Evaluate representative points to create bucket rows:
      // We'll pick key boundary values based on lines. This is heuristic but produces correct classifications around thresholds.
      // For spreads: thresholds for each bet are at x = -line (A side) or x = line (B side), etc. We'll sample around both.
      // For totals/props: thresholds at x = line.
      const samples = [];
      function addSample(x){ if(isFinite(x)) samples.push(x); }
      if(state.betType === "spread"){
        // thresholds where each bet pushes:
        const prePush = (preSide==="A") ? -preLine : preLine;
        const livePush = (liveSide==="A") ? -liveLine : liveLine;
        addSample(prePush-0.5); addSample(prePush); addSample(prePush+0.5);
        addSample(livePush-0.5); addSample(livePush); addSample(livePush+0.5);
      } else {
        addSample(preLine-0.5); addSample(preLine); addSample(preLine+0.5);
        addSample(liveLine-0.5); addSample(liveLine); addSample(liveLine+0.5);
      }

      // Deduplicate + sort
      const uniq = Array.from(new Set(samples.map(x=>Number(x).toFixed(6)))).map(x=>Number(x));
      uniq.sort((a,b)=>a-b);

      // Determine bucket payout for each sample, then collapse into buckets
      const buckets = new Map(); // key -> {label, happens, pnlExact, pnlMin, pnlMax}
      function keyFromResults(rPre, rLive){
        if(rPre==="win" && rLive==="win") return "MIDDLE";
        if(rPre==="win" && rLive==="loss") return "PRE";
        if(rPre==="loss" && rLive==="win") return "LIVE";
        if(rPre==="push" && rLive!=="push") return "PUSH_PRE";
        if(rLive==="push" && rPre!=="push") return "PUSH_LIVE";
        if(rPre==="push" && rLive==="push") return "DOUBLE_PUSH";
        if(rPre==="loss" && rLive==="loss") return "BOTH_LOSE";
        return "OTHER";
      }

      function pnlFor(rPre, rLive, liveProfit){
        const prePnl = (rPre==="win") ? preWinProfit : (rPre==="push" ? 0 : -preStake);
        const livePnl = (rLive==="win") ? liveProfit : (rLive==="push" ? 0 : -liveStake);
        return prePnl + livePnl;
      }

      uniq.forEach(x=>{
        const rPre = btRes(preSide, preLine, x);
        const rLive = btRes(liveSide, liveLine, x);

        const k = keyFromResults(rPre, rLive);

        const pnlExact = pnlFor(rPre, rLive, liveWinProfit);
        const pnlMin   = pnlFor(rPre, rLive, liveWinProfitMin);
        const pnlMax   = pnlFor(rPre, rLive, liveWinProfitMax);

        if(!buckets.has(k)){
          buckets.set(k, {
            key:k,
            label:k,
            happens: expl.describe(k),
            pnlExact, pnlMin, pnlMax
          });
        } else {
          // Keep worst-to-best range for that bucket
          const b = buckets.get(k);
          b.pnlExact = Math.min(b.pnlExact, pnlExact); // pick conservative representative
          b.pnlMin = Math.min(b.pnlMin, pnlMin);
          b.pnlMax = Math.max(b.pnlMax, pnlMax);
        }

        best = Math.max(best, pnlExact);
        worst = Math.min(worst, pnlExact);
        bestMin = Math.max(bestMin, pnlMin);
        bestMax = Math.max(bestMax, pnlMax);
        worstMin = Math.min(worstMin, pnlMin);
        worstMax = Math.min(worstMax, pnlMax);
      });

      // Render rows in a logical order
      const order = ["MIDDLE","PRE","LIVE","PUSH_PRE","PUSH_LIVE","DOUBLE_PUSH","BOTH_LOSE","OTHER"];
      order.forEach(k=>{
        if(!buckets.has(k)) return;
        const b = buckets.get(k);

        let name = b.label;
        if(k==="MIDDLE") name = "Middle window";
        if(k==="PRE") name = "Pregame covers only";
        if(k==="LIVE") name = "Live bet covers only";
        if(k==="PUSH_PRE") name = "Pregame push";
        if(k==="PUSH_LIVE") name = "Live push";
        if(k==="DOUBLE_PUSH") name = "Double push";
        if(k==="BOTH_LOSE") name = "Both lose";
        if(k==="OTHER") name = "Other edge-case";

        addRow(name, b.happens, b.pnlExact, b.pnlMin, b.pnlMax);
      });

      $("kpiBest").textContent = fmtMoney(best);
      $("kpiBestRange").textContent = `(range: ${fmtMoney(bestMin)} to ${fmtMoney(bestMax)})`;
      $("kpiWorst").textContent = fmtMoney(worst);
      $("kpiWorstRange").textContent = `(range: ${fmtMoney(worstMin)} to ${fmtMoney(worstMax)})`;

      $("preWinProfit").textContent = fmtMoney(preWinProfit);
      $("liveWinProfit").textContent = fmtMoney(liveWinProfit);
      $("liveWinProfitRange").textContent = `(range: ${fmtMoney(liveWinProfitMin)} to ${fmtMoney(liveWinProfitMax)})`;

      // Headline: show current stake’s best-case exact + drift
      $("headline").textContent = fmtMoney(best);
      $("headlineSub").textContent = `(live odds drift range: ${fmtMoney(bestMin)} to ${fmtMoney(bestMax)})`;

      // Middle note: interpret window
      const A = state.teamA || "Team A";
      const B = state.teamB || "Team B";
      let note = "";
      if(bt === "spread"){
        note = `Spread math uses final margin (A − B). Pregame: ${sideText(preSide,A,B)} ${fmtLine(preLine)} at ${fmtOdds(preOdds)} on ${fmtMoney(preStake)}. Live: ${sideText(liveSide,A,B)} ${fmtLine(liveLine)} at ${fmtOdds(liveOdds)} on ${fmtMoney(liveStake)}.`;
      } else {
        note = `${bt.toUpperCase()} math uses final total compared to line. Pregame: ${sideText(preSide,A,B)} ${fmtLine(preLine)} at ${fmtOdds(preOdds)} on ${fmtMoney(preStake)}. Live: ${sideText(liveSide,A,B)} ${fmtLine(liveLine)} at ${fmtOdds(liveOdds)} on ${fmtMoney(liveStake)}.`;
      }
      $("middleNote").textContent = note;
    }

    function fmtOdds(o){
      const n = Number(o);
      if(!isFinite(n)) return "";
      return (n>0?`+${n}`:`${n}`);
    }
    function fmtLine(x){
      if(x === null || x === undefined || x === "" || !isFinite(Number(x))) return "";
      const n = Number(x);
      return (n>0?`+${n}`:`${n}`);
    }
    function sideText(s, A, B){
      if(s==="A") return A;
      if(s==="B") return B;
      if(s==="over") return "Over";
      if(s==="under") return "Under";
      return s;
    }

    // -------------------------
    // UI: step navigation
    // -------------------------
    const panels = ["panel1","panel2","panel3","panel4"];
    function showStep(n){
      panels.forEach((pid, idx)=>{
        $(pid).classList.toggle("hidden", idx !== (n-1));
      });
      document.querySelectorAll(".step").forEach(el=>{
        el.classList.toggle("active", Number(el.dataset.step) === n);
      });
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // Stepper click
    document.querySelectorAll(".step").forEach(el=>{
      el.addEventListener("click", ()=>{
        const n = Number(el.dataset.step);
        showStep(n);
      });
    });

    $("to2").addEventListener("click", ()=>showStep(2));
    $("back1").addEventListener("click", ()=>showStep(1));
    $("to3").addEventListener("click", ()=>showStep(3));
    $("back2").addEventListener("click", ()=>showStep(2));
    $("to4").addEventListener("click", ()=>{
      compute();
      showStep(4);
    });
    $("back3").addEventListener("click", ()=>showStep(3));

    // Copy summary
    $("copySummary").addEventListener("click", async ()=>{
      const A = state.teamA || "Team A";
      const B = state.teamB || "Team B";
      const lines = [];
      lines.push(`Will’s Middling & Hedge Calculator`);
      lines.push(`League: ${state.league} • Bet type: ${state.betType}`);
      lines.push(`Teams: ${A} vs ${B}`);
      lines.push(`Pregame: ${sideText(state.pre.side,A,B)} ${fmtLine(state.pre.line)} • stake ${fmtMoney(state.pre.stake)} • odds ${fmtOdds(state.pre.odds)}`);
      lines.push(`Live: ${sideText(state.live.side,A,B)} ${fmtLine(state.live.line)} • stake ${fmtMoney(state.live.stake)} • odds ${fmtOdds(state.live.odds)} (±${state.drift})`);
      lines.push(`Best-case: ${$("kpiBest").textContent} ${$("kpiBestRange").textContent}`);
      lines.push(`Worst-case: ${$("kpiWorst").textContent} ${$("kpiWorstRange").textContent}`);
      const txt = lines.join("\n");
      try{
        await navigator.clipboard.writeText(txt);
        $("copyMsg").textContent = "Copied.";
        setTimeout(()=>{$("copyMsg").textContent="";}, 1200);
      }catch(e){
        $("copyMsg").textContent = "Copy failed (clipboard permission).";
      }
    });

    // -------------------------
    // League/team dropdowns
    // -------------------------
    function fillTeams(){
      const league = $("league").value;
      const list = TEAMS[league] || ["Team A","Team B"];
      const aSel = $("teamA");
      const bSel = $("teamB");
      aSel.innerHTML = "";
      bSel.innerHTML = "";

      list.forEach(t=>{
        const oa = document.createElement("option");
        oa.value = t; oa.textContent = t;
        aSel.appendChild(oa);

        const ob = document.createElement("option");
        ob.value = t; ob.textContent = t;
        bSel.appendChild(ob);
      });

      // Keep defaults unless user already picked something valid
      if(!list.includes(state.teamA)) state.teamA = "Team A";
      if(!list.includes(state.teamB)) state.teamB = "Team B";

      aSel.value = state.teamA;
      bSel.value = state.teamB;
    }

    $("league").addEventListener("change", ()=>{
      state.league = $("league").value;
      fillTeams();
    });

    $("teamA").addEventListener("change", ()=> state.teamA = $("teamA").value );
    $("teamB").addEventListener("change", ()=> state.teamB = $("teamB").value );

    // -------------------------
    // Bet type pills
    // -------------------------
    document.querySelectorAll("#betTypeRow .pill").forEach(p=>{
      p.addEventListener("click", ()=>{
        document.querySelectorAll("#betTypeRow .pill").forEach(x=>x.classList.remove("active"));
        p.classList.add("active");
        state.betType = p.dataset.type;
        syncBetTypeUI();
      });
    });

    function syncBetTypeUI(){
      const bt = state.betType;

      // Side selects
      const preSide = $("preSide");
      const liveSide = $("liveSide");
      preSide.innerHTML = "";
      liveSide.innerHTML = "";

      if(bt === "spread" || bt === "ml"){
        // Team A/B only
        ["A","B"].forEach(v=>{
          const o1 = document.createElement("option");
          o1.value = v; o1.textContent = (v==="A" ? "Team A" : "Team B");
          preSide.appendChild(o1);

          const o2 = document.createElement("option");
          o2.value = v; o2.textContent = (v==="A" ? "Team A" : "Team B");
          liveSide.appendChild(o2);
        });
        // Default hedge to opposite
        state.pre.side = "A";
        state.live.side = "B";
        $("preSide").value = state.pre.side;
        $("liveSide").value = state.live.side;

        $("preLineHint").textContent = (bt==="ml")
          ? "Moneyline: line not used (can leave blank)."
          : "Examples: -3.5, +7.5";
        $("liveLineHint").textContent = (bt==="ml")
          ? "Moneyline: line not used (can leave blank)."
          : "Examples: +7.5, -2.5";

      } else {
        // Over/Under
        ["over","under"].forEach(v=>{
          const o1 = document.createElement("option");
          o1.value = v; o1.textContent = (v==="over" ? "Over" : "Under");
          preSide.appendChild(o1);

          const o2 = document.createElement("option");
          o2.value = v; o2.textContent = (v==="over" ? "Over" : "Under");
          liveSide.appendChild(o2);
        });
        state.pre.side = "over";
        state.live.side = "under";
        $("preSide").value = state.pre.side;
        $("liveSide").value = state.live.side;

        $("preLineHint").textContent = "Examples: 45.5 (total) • 3.5 (prop)";
        $("liveLineHint").textContent = "Examples: 52.5 (total) • 4.5 (prop)";
      }

      // Preserve entered lines; for ML, allow blank line but keep as number internally
      if(bt === "ml"){
        $("preLine").value = "";
        $("liveLine").value = "";
      } else {
        if($("preLine").value === "") $("preLine").value = state.pre.line ?? 0;
        if($("liveLine").value === "") $("liveLine").value = state.live.line ?? 0;
      }
    }

    // -------------------------
    // Bind inputs
    // -------------------------
    $("preSide").addEventListener("change", ()=> state.pre.side = $("preSide").value);
    $("preLine").addEventListener("input", ()=> state.pre.line = Number($("preLine").value));
    $("preStake").addEventListener("input", ()=> state.pre.stake = Number($("preStake").value));
    $("preOdds").addEventListener("input", ()=> state.pre.odds = Number($("preOdds").value));

    $("liveSide").addEventListener("change", ()=> state.live.side = $("liveSide").value);
    $("liveLine").addEventListener("input", ()=> state.live.line = Number($("liveLine").value));
    $("liveOdds").addEventListener("input", ()=> state.live.odds = Number($("liveOdds").value));

    $("liveStakeMax").addEventListener("input", ()=>{
      const max = Math.max(0, Number($("liveStakeMax").value) || 0);
      state.live.max = max;
      $("liveStake").max = String(max);
      // keep current value within range
      const v = clamp(Number($("liveStake").value)||0, 0, max);
      $("liveStake").value = String(v);
      state.live.stake = v;
      $("liveStakeLabel").textContent = fmtMoney(v);
    });

    $("liveStake").addEventListener("input", ()=>{
      const v = Number($("liveStake").value) || 0;
      state.live.stake = v;
      $("liveStakeLabel").textContent = fmtMoney(v);
    });

    // -------------------------
    // Init defaults
    // -------------------------
    fillTeams();
    syncBetTypeUI();

    // Default stakes to $20 across components
    $("preStake").value = 20;
    $("liveStake").value = 20;
    $("liveStakeLabel").textContent = "$20";
    state.pre.stake = 20;
    state.live.stake = 20;

    // Ensure max slider matches
    $("liveStake").max = $("liveStakeMax").value;

  </script>

  <div class="giftBottom">
    <img src="bottom%20photo.png" alt="Will’s Middling & Hedging Calculator - Bottom Banner" loading="lazy" decoding="async"/>
  </div>
</body>
</html>
